<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BED HOSPITALITY 2.0 — Launcher</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 16px; }
    .nav { display: flex; gap: 12px; margin-bottom: 12px; }
    .nav button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; cursor: pointer; }
    .hint { font-size: 12px; color: #666; margin-bottom: 10px; }
    iframe { width: 100%; height: 88vh; border: 1px solid #eee; border-radius: 12px; }
  </style>
</head>
<body>
  <div class="nav">
    <button id="btnTeam">Open TEAM form</button>
    <button id="btnPeer">Open PEER form</button>
  </div>
  <div class="hint">Complete the form to the final summary; data syncs automatically.</div>
  <iframe id="formFrame" src="" referrerpolicy="no-referrer"></iframe>

  <script>
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz0ajD4RXhjsLhKKrWM8pbw3NDMJKYKhwCuNcA54fSxUknez9dPnr6WSHZDwSnzzIfl/exec';

  const qs  = (doc, s) => doc.querySelector(s);
  const txt = (el) => el ? (('value' in el) ? String(el.value).trim() : String(el.textContent).trim()) : '';
  const pick = (doc, arr) => { for (const s of arr) { const el = qs(doc, s); if (el) return el; } return null; };
  const pct = (doc, s) => { const t = txt(qs(doc, s)); const m = t.match(/(\d+(?:\.\d+)?)\s*%/); return m ? +m[1] : (t ? +t.replace(/[^\d.]/g,'') : ''); };

  function collectRow(doc) {
    const ts = new Date().toISOString();
    const nick = txt(qs(doc, '#nick'));
    const email = txt(qs(doc, '#email')).toLowerCase();
    const loc = txt(pick(doc, ['#location', '#loc', 'select[name="location"]']));

    const answers = [];
    for (let i = 1; i <= 35; i++) {
      const el = qs(doc, `input[name="q${i}"]:checked, [data-q="${i}"][aria-checked="true"]`);
      answers.push(el ? (el.value ?? el.textContent ?? '').toString().trim() : '');
    }

    const g1 = pct(doc, '#group1Percent, #g1Pct, [data-g1]');
    const g2 = pct(doc, '#group2Percent, #g2Pct, [data-g2]');
    const g3 = pct(doc, '#group3Percent, #g3Pct, [data-g3]');
    const g4 = pct(doc, '#group4Percent, #g4Pct, [data-g4]');
    const overall = pct(doc, '#scorePercent');
    const recommendation = txt(qs(doc, '#recText'));

    return [
      ts,
      nick, email, loc,     // NAME TEAM MEMBER (NICKNAME), EMAIL TEAM MEMBER, LOCATION TEAM MEMBER
      nick, email, loc,     // NAME PEER REVIEWER (NICKNAME), EMAIL PEER REVIEWER, LOCATION PEER REVIEWER
      ...answers,
      g1, g2, g3, g4,
      overall,
      recommendation
    ];
  }

  async function postRow(type, row) {
    try {
      const r = await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ type, row })
      });
      console.log('posted:', await r.text());
    } catch (e) { console.error('post error:', e); }
  }

  async function enhanceChild(win, type) {
    const doc = win.document;

    // Email validation
    const emailInput = qs(doc, '#email');
    const form = emailInput ? (emailInput.closest('form') || qs(doc, 'form')) : null;
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
    function validate() {
      if (!emailInput) return;
      const v = (emailInput.value || '').trim();
      emailInput.setCustomValidity?.(re.test(v) ? '' : 'Please enter a valid email address.');
    }
    if (emailInput && form) {
      emailInput.addEventListener('input', validate);
      form.addEventListener('submit', (e) => {
        validate();
        if (!form.checkValidity?.() || emailInput.validationMessage) {
          e.preventDefault(); form.reportValidity?.(); emailInput.focus();
        }
      });
    }

    // Nickname → email autofill (uses /team|/peer/emails.json)
    try {
      const path = type === 'peer' ? 'peer/emails.json' : 'team/emails.json';
      const res = await fetch(path);
      const list = await res.json();
      const nameInput = qs(doc, '#nick');
      if (nameInput && emailInput) {
        const fill = () => {
          const nick = (nameInput.value || '').trim().toLowerCase();
          const m = list.find(p => (p.nickname || '').toLowerCase() === nick);
          if (m?.email) emailInput.value = m.email;
        };
        nameInput.addEventListener('change', fill);
        nameInput.addEventListener('blur', fill);
      }
    } catch {}

    // When summary is visible, send
    const finish = qs(doc, '#finish');
    if (!finish) return;
    const visible = () => finish && getComputedStyle(finish).display !== 'none' && finish.style.display !== 'none';
    if (visible()) { await postRow(type, collectRow(doc)); return; }
    const mo = new win.MutationObserver(async () => {
      if (visible()) { mo.disconnect(); await postRow(type, collectRow(doc)); }
    });
    mo.observe(finish, { attributes: true, attributeFilter: ['style','class'] });
  }

  const frame = document.getElementById('formFrame');
  document.getElementById('btnTeam').onclick = () => { frame.src = 'team/index.html'; };
  document.getElementById('btnPeer').onclick = () => { frame.src = 'peer/index.html'; };

  frame.addEventListener('load', () => {
    try {
      const win = frame.contentWindow;
      const type = /\/peer\/?/.test(new URL(frame.src, location.href).pathname) ? 'peer' : 'team';
      enhanceChild(win, type);
    } catch (e) { console.error('iframe access error:', e); }
  });
  </script>
</body>
</html>
