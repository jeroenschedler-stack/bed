<script>
const GS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwNeW_zk5Hzzxk1OmHsvREb9XCIe3Fae8-QnYroO9rhtL3nB9RuQjkHNrkOdCAC33Gj/exec';

const $ = (s, r=document) => r.querySelector(s);
const app = $('#app');
const statusBox = (() => {
  const el = document.createElement('div');
  el.id = 'status';
  el.style.cssText = 'position:fixed;right:10px;bottom:10px;padding:8px 12px;border-radius:6px;font:14px system-ui,sans-serif;display:none;z-index:9999';
  document.body.appendChild(el);
  return el;
})();
function showStatus(msg, ok=true){
  statusBox.textContent = msg;
  statusBox.style.display = 'inline-block';
  statusBox.style.background = ok ? '#d4edda' : '#f8d7da';
  statusBox.style.color = ok ? '#155724' : '#721c24';
  setTimeout(()=> statusBox.style.display='none', 4000);
}

function currentFormType(doc){
  const sub = doc.querySelector('.subheader, h2')?.textContent?.toLowerCase() || '';
  // Look for the big page title too
  const h1 = doc.querySelector('h1')?.nextElementSibling?.textContent?.toLowerCase() || '';
  const text = sub + ' ' + h1;
  return text.includes('peer') ? 'peer' : 'team';
}

function collectFields(doc){
  // ensure inputs have names
  doc.querySelectorAll('input[id], select[id], textarea[id]').forEach(el=>{
    if (!el.name) el.name = el.id;
  });

  const obj = { form: currentFormType(doc) };

  const formEl = doc.querySelector('form');
  if (formEl){
    const fd = new FormData(formEl);
    for (const [k,v] of fd.entries()) obj[k] = v;
  } else {
    doc.querySelectorAll('input, select, textarea, [data-field]').forEach(el=>{
      const name = el.name || el.dataset.field;
      if (!name) return;
      if ((el.type === 'checkbox' || el.type === 'radio')) {
        if (el.checked) obj[name] = el.value || 'on';
      } else {
        obj[name] = el.value ?? '';
      }
    });
  }

  const scoreEl = doc.getElementById('scorePercent');
  if (scoreEl) obj.score_percent = scoreEl.textContent.trim();

  return obj;
}

async function postToSheet(payload){
  const params = new URLSearchParams();
  Object.entries(payload).forEach(([k,v]) => params.append(k, String(v)));
  const res = await fetch(GS_ENDPOINT, {
    method: 'POST',
    headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
    body: params.toString()
  });
  let json = null;
  try { json = await res.json(); } catch(_){}
  if (!res.ok || !json || json.ok !== true) {
    const msg = json && json.error ? json.error : `HTTP ${res.status}`;
    throw new Error(msg);
  }
}

async function saveNow(doc, tag='auto'){
  const data = collectFields(doc);
  data._trigger = tag;
  await postToSheet(data);
  showStatus('✔ Saved!', true);
}

function attachTriggers(){
  const doc = app.contentDocument || app.contentWindow.document;

  // 1) Submit button click (e.g. id="submitAll", text "Submit")
  doc.addEventListener('click', (ev)=>{
    const el = ev.target.closest('button, [role="button"], input[type="submit"]');
    if (!el) return;
    const txt = (el.textContent || el.value || '').trim().toLowerCase();
    if (/(submit|finish|complete|done)/.test(txt) || el.id === 'submitAll') {
      saveNow(doc, 'submit-click').catch(e=>showStatus('✖ Error: '+e.message,false));
    }
    // 3) Also save if they tap PDF on the congrats screen
    if (/(pdf)/.test(txt) || el.id === 'congratsPdf') {
      saveNow(doc, 'pdf-click').catch(e=>showStatus('✖ Error: '+e.message,false));
    }
  }, {capture:true});

  // 2) When the score section (#finish) becomes visible
  const finish = doc.getElementById('finish');
  if (finish){
    const obs = new MutationObserver(()=>{
      const visible = finish.style.display !== 'none';
      if (visible) {
        saveNow(doc, 'finish-visible').catch(e=>showStatus('✖ Error: '+e.message,false));
      }
    });
    obs.observe(finish, {attributes:true, attributeFilter:['style']});
  }
}

app.addEventListener('load', attachTriggers);
</script>
