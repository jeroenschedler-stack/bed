<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BED Bridge</title>
  <style>
    html,body,iframe { height: 100%; width: 100%; margin: 0; border: 0; }
  </style>
</head>
<body>
  <!-- This loads your original form -->
  <iframe id="app" src="./index.html"></iframe>

  <script>
  /* ====== CONFIG ====== */
  const GS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwNeW_zk5Hzzxk1OmHsvREb9XCIe3Fae8-QnYroO9rhtL3nB9RuQjkHNrkOdCAC33Gj/exec';
  /* ==================== */

  const $ = (s, r=document) => r.querySelector(s);
  const app = $('#app');

  function collectFieldsFromIframe() {
    const doc = app.contentDocument || app.contentWindow.document;
    doc.querySelectorAll('input[id], select[id], textarea[id]').forEach(el=>{
      if (!el.name) el.name = el.id;
    });

    const obj = {
      form: location.pathname.includes('peer') ? 'peer' : 'team'
    };

    const formEl = doc.querySelector('form');
    if (formEl) {
      const fd = new FormData(formEl);
      for (const [k,v] of fd.entries()) obj[k] = v;
    } else {
      doc.querySelectorAll('input, select, textarea, [data-field]').forEach(el=>{
        const name = el.name || el.dataset.field;
        if (!name) return;
        if ((el.type === 'checkbox' || el.type === 'radio')) {
          if (el.checked) obj[name] = el.value || 'on';
        } else {
          obj[name] = el.value ?? '';
        }
      });
    }

    const scoreEl = doc.getElementById('scorePercent');
    if (scoreEl) obj.score_percent = scoreEl.textContent.trim();

    return obj;
  }

  async function postToSheet(payload) {
    const params = new URLSearchParams();
    Object.entries(payload).forEach(([k,v]) => params.append(k, String(v)));
    const res = await fetch(GS_ENDPOINT, {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'},
      body: params.toString()
    });
    return res.json().catch(()=>({ok:true}));
  }

  async function saveNow(tag='auto') {
    try {
      const data = collectFieldsFromIframe();
      data._trigger = tag;
      await postToSheet(data);
      console.log('[bridge] saved via', tag);
    } catch (e) {
      console.warn('[bridge] save failed', e);
    }
  }

  app.addEventListener('load', ()=>{
    const doc = app.contentDocument || app.contentWindow.document;
    doc.addEventListener('click', (ev)=>{
      const el = ev.target.closest('button, [role="button"], input[type="submit"]');
      if (!el) return;
      const txt = (el.textContent || el.value || '').trim().toLowerCase();
      if (/(finish|submit|complete|done)/.test(txt)) {
        saveNow('button-click');
      }
    }, {capture:true});
  });
  </script>
</body>
</html>
