<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8" />
      <meta content="width=device-width, initial-scale=1" name="viewport" />
      <title>BED HOSPITALITY 2.0 PEER REVIEW FORM</title>
      <!-- Shared styles -->
      <link rel="stylesheet" href="../shared/style.css?v=1">
      <link rel="stylesheet" href="../shared/peer.css?v=1">
      <!-- Embedded questions (kept here, not in CSS) -->
      <script id="embeddedQuestions" type="application/json">[]</script>
      <script>
         document.addEventListener("DOMContentLoaded", () => {
           const bust = Date.now();
           document.querySelectorAll('link[rel="stylesheet"]').forEach(el => {
             const href = el.getAttribute("href") || "";
             el.setAttribute("href", href + (href.includes("?") ? "&" : "?") + "v=" + bust);
           });
         });
      </script>
   </head>
   <body>
      <main class="container">
         <h1>BED HOSPITALITY 2.0</h1>
         <p class="subheader">PEER REVIEW FORM</p>
         <div class="progress" id="progressHeader"><span class="dot"></span><span class="dot"></span><span class="dot"></span> <span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
         <!-- PAGE 1 -->
         <section id="welcome">
            <h2 class="section-title">peer reviewer information</h2>
            <div class="row"><label for="nick">your name</label><input id="nick" /></div>
            <div class="row"><label for="email">your email</label><input id="email" type="email" /></div>
            <div class="row">
               <label for="hotel">your location</label>
               <select id="hotel" required="">
                  <option disabled="" selected="" value="">select hotel</option>
                  <option>BED Changkian</option>
                  <option>BED Phrasingh</option>
                  <option>BED Nimman</option>
                  <option>BED Chiangmai Gate</option>
                  <option>BED Flying</option>
                  <option>BED Support</option>
               </select>
            </div>
            <h2 class="section-title">team member information</h2>
            <p class="intro">
               enter the details of the team member you will review. you must know this team member well and have worked in BED for at least 12 months
            </p>
            <div class="row"><label for="peerName">team member name</label><input id="peerName" /></div>
            <div class="row"><label for="peerEmail">team member email</label><input id="peerEmail" type="email" /></div>
            <div class="row">
               <label for="peerHotel">team member location</label>
               <select id="peerHotel" required="">
                  <option disabled="" selected="" value="">select hotel</option>
                  <option>BED Changkian</option>
                  <option>BED Phrasingh</option>
                  <option>BED Nimman</option>
                  <option>BED Chiangmai Gate</option>
                  <option>BED Flying</option>
                  <option>BED Support</option>
               </select>
            </div>
            <div class="actions">
               <button disabled="" id="toInstructions">Start</button>
            </div>
         </section>
         <!-- Instructions -->
         <section id="instructions" style="display: none;">
            <h2 class="section-title">INSTRUCTIONS</h2>
            <p class="intro">
               Read each statement and think how this team member acts in these situations. Then select the rating that fits best. Be honest and sincere. The goal is for your friends to know what they're good at and what they can do
               better
            </p>
            <h2 class="section-title">RATING</h2>
            <ul class="scale-list" style="list-style: none; padding: 0; margin: 10px 0;">
               <li class="scale-item" style="display: flex; align-items: center; gap: 10px; margin: 8px 0; font-size: 12pt;">
                  <span class="badge" style="width: 28px; height: 28px; border-radius: 50%; background: var(--blue); color: #fff; display: inline-flex; align-items: center; justify-content: center; font-weight: 700;">1</span>
                  <span>You are not so good at this</span>
               </li>
               <li class="scale-item" style="display: flex; align-items: center; gap: 10px; margin: 8px 0; font-size: 12pt;">
                  <span class="badge" style="width: 28px; height: 28px; border-radius: 50%; background: var(--blue); color: #fff; display: inline-flex; align-items: center; justify-content: center; font-weight: 700;">2</span>
                  <span>You can be better at this</span>
               </li>
               <li class="scale-item" style="display: flex; align-items: center; gap: 10px; margin: 8px 0; font-size: 12pt;">
                  <span class="badge" style="width: 28px; height: 28px; border-radius: 50%; background: var(--blue); color: #fff; display: inline-flex; align-items: center; justify-content: center; font-weight: 700;">3</span>
                  <span>You are average at this</span>
               </li>
               <li class="scale-item" style="display: flex; align-items: center; gap: 10px; margin: 8px 0; font-size: 12pt;">
                  <span class="badge" style="width: 28px; height: 28px; border-radius: 50%; background: var(--blue); color: #fff; display: inline-flex; align-items: center; justify-content: center; font-weight: 700;">4</span>
                  <span>You are good at this</span>
               </li>
               <li class="scale-item" style="display: flex; align-items: center; gap: 10px; margin: 8px 0; font-size: 12pt;">
                  <span class="badge" style="width: 28px; height: 28px; border-radius: 50%; background: var(--blue); color: #fff; display: inline-flex; align-items: center; justify-content: center; font-weight: 700;">5</span>
                  <span>You are very good at this</span>
               </li>
            </ul>
            <br />
            <br />
            <div class="actions">
               <button class="btn-secondary" id="backToWelcome">Back</button>
               <button id="toQ1">Start</button>
            </div>
         </section>
         <!-- Q1 -->
         <section id="q1" style="display: none;">
            <h2 class="visually-hidden">Question 1</h2>
            <div id="list-q1"></div>
            <div class="actions">
               <button class="btn-secondary" id="backToInstructions">Back</button>
               <button id="toQ2">Next</button>
            </div>
         </section>
         <!-- Q2 -->
         <section id="q2" style="display: none;">
            <h2 class="visually-hidden">Question 2</h2>
            <div id="list-q2"></div>
            <div class="actions">
               <button class="btn-secondary" id="backToQ1">Back</button>
               <button id="submitAll">Submit</button>
            </div>
         </section>
         <!-- Score -->
         <section id="finish" style="display: none;">
            <h2 class="visually-hidden">Overall Score</h2>
            <div class="score-section">
               <div class="score-kicker">peer reviewer score</div>
               <div class="score-big" id="scorePercent">OVERALL SCORE —%</div>
               <div class="gauge" id="gauge"></div>
               <div class="rec-kicker"></div>
               <div class="rec-text" id="recText">—</div>
            </div>
            <br />
            <div id="groupResultsContainer" style="margin-top: 18px;">
               <div class="group-summary">
                  <div class="group-results-header group-title" style="font-weight: 900; margin-bottom: 8px;">SCORE BY GROUP</div>
                  <br />
                  <div id="groupResults"></div>
               </div>
            </div>
            <div class="actions">
               <button class="btn-secondary" id="backToQ2">Back</button>
               <button id="nextToPeer">Next</button>
            </div>
         </section>
         <!-- Congrats -->
         <section id="congrats" style="display: none;">
            <br />
            <br />
            <br />
            <div class="big-check"></div>
            <div class="center">
               <h3 style="font-size: 32px; margin: 8px 0 6px 0; color: #444;">
                  peer assessment<br />
                  completed
               </h3>
               <p style="font-size: 17px; font-weight: 500; color: #444; line-height: 1.4;">
                  click PDF to download the report<br />
                  please send a copy to your team member
               </p>
            </div>
            <br />
            <br />
            <br />
            <div class="page-actions" style="display: flex; gap: 14px; justify-content: center; margin-top: 10px;">
               <button class="btn-secondary btn-wide" id="congratsBack">Back</button>
               <button class="btn-wide" id="congratsPdf">PDF</button>
            </div>
         </section>
      </main>
      <!-- Modal -->
      <div class="modal-backdrop" id="eligBackdrop" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.35); display: none; align-items: center; justify-content: center; z-index: 50;">
         <div class="modal" style="width: min(92vw, 520px); background: #fff; border-radius: 18px; padding: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);">
            <h3 style="margin: 0 0 10px 0; font-size: 18px;">please confirm</h3>
            <p style="margin: 0 0 18px 0; font-size: 16px; line-height: 1.5; color: #222;">I know this team member well and I worked in BED for at least 12 months</p>
            <div class="row-btns" style="display: flex; justify-content: flex-end; gap: 10px;">
               <button class="btn-secondary" id="eligCancel">Cancel</button>
               <button id="eligOk">OK</button>
            </div>
         </div>
      </div>
      <!-- PRINT REPORT (Blue-branded) -->
      <section aria-hidden="true" id="pdfReport">
         <h2 class="visually-hidden">PDF Report</h2>
         <div class="pdf-top">
            <div>
               <div class="pdf-title">BED HOSPITALITY 2.0</div>
               <div class="pdf-sub">peer review report</div>
               <div class="pdf-date" id="pdfDate">assessment date —</div>
            </div>
            <div class="score-box">
               <div class="pct" id="pdfTotalPct">—%</div>
               <div class="raw" id="pdfTotalRaw">— OUT OF 175 POINTS</div>
            </div>
         </div>
         <div class="pdf-divider"></div>
         <!-- Information section -->
         <div class="sec-h assess-bar"><span class="lbl-group">INFORMATION</span></div>
         <div class="card" style="padding: 0;">
            <table id="pdfInfoTable">
               <colgroup>
                  <col style="width: 20%;" />
                  <col style="width: 30%;" />
                  <col style="width: 20%;" />
                  <col style="width: 30%;" />
               </colgroup>
               <tbody>
                  <tr>
                     <td>peer reviewer</td>
                     <td id="pdfEmpName"></td>
                     <td>team member</td>
                     <td id="pdfPeerName"></td>
                  </tr>
                  <tr>
                     <td>peer email</td>
                     <td id="pdfEmpEmail"></td>
                     <td>team email</td>
                     <td id="pdfPeerEmail"></td>
                  </tr>
                  <tr>
                     <td>peer location</td>
                     <td id="pdfEmpHotel"></td>
                     <td>team location</td>
                     <td id="pdfPeerHotel"></td>
                  </tr>
               </tbody>
            </table>
         </div>
         <!--  section -->
         <div class="sec-h assess-bar"><span class="lbl-group">SCORE SUMMARY</span></div>
         <div id="pdfBandText" style="margin-top: 10px; font-size: 16px; font-weight: 600; color: #434343; width: 100%; display: block; text-align: left; line-height: 1.5;"></div>
         <!-- Score by Group section -->
         <div class="sec-h assess-bar"><span class="lbl-group">SCORE BY GROUP</span></div>
         <div class="card" style="padding: 0;">
            <table>
               <tbody id="pdfGroupRows">
                  <!-- rows injected -->
               </tbody>
            </table>
         </div>
         <!-- Statements -->
         <div class="sec-h statements-bar">
            <span class="lbl-stmt" style="display: block;">STATEMENTS</span>
            <span class="lbl-group" style="display: block;">GROUP</span>
            <span class="lbl-score" style="display: block;">SCORE</span>
         </div>
         <div class="card" style="padding: 0;">
            <table id="pdfStatements">
               <colgroup>
                  <col />
                  <!-- NO -->
                  <col />
                  <!-- STATEMENT -->
                  <col />
                  <!-- GROUP -->
                  <col />
                  <!-- SCORE -->
               </colgroup>
               <thead>
                  <tr>
                     <th>NO</th>
                     <th>STATEMENT</th>
                     <th>GROUP</th>
                     <th>SCORE</th>
                  </tr>
               </thead>
               <tbody id="pdfStatementRows">
                  <!-- rows injected -->
               </tbody>
            </table>
         </div>
      </section>
      <script>
         (function () {
             const S = { answers: {}, questions: [], groups: [] };
             window.__S = S;
             const el = (id) => document.getElementById(id);
             const sections = ["welcome", "instructions", "q1", "q2", "finish", "congrats"];
         
             function show(id) {
         sections.forEach((s) => (document.getElementById(s).style.display = s === id ? "block" : "none"));
         let n = 1;
         if (id === "instructions") n = 2;
         else if (id === "q1") n = 3;
         else if (id === "q2") n = 4;
         else if (id === "finish") n = 5;
         else if (id === "congrats") n = 6;
         setProgress(n);
         window.scrollTo({ top: 0, behavior: "smooth" });
         }
         
         // Expose globally so later patches can wrap/override
         window.show = show;
         
         function setProgress(n) {
         const dots = document.querySelectorAll("#progressHeader .dot");
         dots.forEach((d, i) => d.classList.toggle("active", i < n));
         }
         
         // Initialize
         setProgress(1);
         
         
            function stripLeadingNumber(t) {
  return String(t || "").replace(/^\s*\d+\.\s*/, "");
}

         
             function makeQ(q, ord) {
                 const wrap = document.createElement("div");
                 wrap.className = "q-item";
                 wrap.dataset.qid = q.id;
                 const num = document.createElement("div");
                 num.className = "q-num";
                 num.textContent = ord + ".";
                 wrap.appendChild(num);
                 const body = document.createElement("div");
                 body.className = "q-body";
                 const title = document.createElement("span");
                 title.className = "q-title";
                 title.textContent = stripLeadingNumber(q.statement || "");
                 body.appendChild(title);
                 if (q.subtext) {
                     const sub = document.createElement("span");
                     sub.className = "q-sub";
                     sub.textContent = q.subtext;
                     body.appendChild(sub);
                 }
                 for (let v = 1; v <= 5; v++) {
                     const p = document.createElement("span");
                     p.className = "pill";
                     p.textContent = v;
                     p.dataset.val = v;
                     p.onclick = () => {
                         S.answers[q.id] = v;
                         wrap.querySelectorAll(".pill").forEach((x) => x.classList.toggle("selected", x === p));
                     };
                     body.appendChild(p);
                 }
                 wrap.appendChild(body);
                 return wrap;
             }
         
             async function loadQuestions() {
                 try {
                     const res = await fetch("questions.json", { cache: "no-store" });
                     if (!res.ok) throw new Error("fetch failed");
                     const data = await res.json();
                     S.questions = data.questions || [];
                     S.groups = data.groups || [];
                 } catch (e) {
                     S.questions = [];
                     S.groups = [
                         { name: "Hospitality skills", description: "Practical service actions and daily guest care done the BED way." },
                         { name: "BED competencies", description: "Reading people and situations; proactive judgement; turning intent into consistent action." },
                         { name: "Taking ownership", description: "Acting independently, fixing problems, and sharing responsibility for outcomes." },
                         { name: "Collaboration", description: "Building trust, communicating clearly, and helping across the BED community." },
                     ];
                 }
             }
         
  function validateWelcome() {
  const emailRx = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
  const v = (id) => (el(id).value || "").trim();

  const allFilled =
    v("nick") && v("email") && v("hotel") &&
    v("peerName") && v("peerEmail") && v("peerHotel");

  const emailsOK = emailRx.test(v("email")) && emailRx.test(v("peerEmail"));
  el("toInstructions").disabled = !(allFilled && emailsOK);
}

         
             function computeTotals() {
                 const ids = (S.questions || []).map((q) => q.id);
                 const answered = ids.filter((id) => S.answers[id] != null);
                 const raw = answered.reduce((sum, id) => sum + (Number(S.answers[id] || 0) || 0), 0);
                 const max = (S.questions || []).length * 5;
                 const avg = answered.length ? raw / answered.length : 0;
                 const pct = answered.length ? Math.round(25 + ((avg - 1) / 4) * 75) : 25;
                 return { raw, max, pct };
             }
         
             function computeGroupPercents() {
                 const byGroup = {};
                 (S.groups || []).forEach((g) => (byGroup[g.name] = []));
                 (S.questions || []).forEach((q) => {
                     const g = q.group;
                     const v = parseInt(S.answers[q.id], 10);
                     if (g && !isNaN(v) && v > 0) byGroup[g].push(v);
                 });
                 const res = {};
                 Object.keys(byGroup).forEach((g) => {
                     const vals = byGroup[g];
                     if (!vals.length) {
                         res[g] = 0;
                         return;
                     }
                     const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
                     res[g] = Math.round(25 + ((avg - 1) / 4) * 75);
                 });
                 return res;
             }
         
             function groupDescMap() {
                 const m = {};
                 (S.groups || []).forEach((g) => (m[g.name] = g.description || ""));
                 return m;
             }
         
             function renderGroupResults() {
                 const holder = document.getElementById("groupResults");
                 if (!holder) return;
                 const gp = computeGroupPercents();
                 const desc = groupDescMap();
                 const order = ["Hospitality Skills", "Hospitality Competencies", "Taking Ownership", "Collaboration"];
                 let rows = "";
                 order.forEach((name) => {
                     const p = gp[name] ?? 0;
                     rows += '<div class="group-row">' + '<div style="font-weight:600">' + name + " " + p + "%</div>" + "</div>" + '<div class="group-desc">' + (desc[name] || "") + "</div>";
                 });
                 holder.innerHTML = rows;
             }
         
             // Navigation + eligibility modal
             const _eligOkBtn = document.getElementById("eligOk");
             const _eligCancelBtn = document.getElementById("eligCancel");
             function openModal() {
                 document.getElementById("eligBackdrop").style.display = "flex";
             }
             function closeModal() {
                 document.getElementById("eligBackdrop").style.display = "none";
             }
         
             el("toInstructions").onclick = () => {
                 openModal();
                 const oldOk = _eligOkBtn.onclick;
                 const oldCancel = _eligCancelBtn.onclick;
                 _eligOkBtn.onclick = () => {
                     closeModal();
                     show("instructions");
                     _eligOkBtn.onclick = oldOk;
                     _eligCancelBtn.onclick = oldCancel;
                 };
                 _eligCancelBtn.onclick = () => {
                     closeModal();
                     _eligOkBtn.onclick = oldOk;
                     _eligCancelBtn.onclick = oldCancel;
                 };
             };
            el("backToWelcome").onclick = () => show("welcome");

  const _goQ1 = () => {
    const l = el("list-q1");
    l.innerHTML = "";
    (S.questions || []).slice(0, 18).forEach((q, i) => l.appendChild(makeQ(q, i + 1)));
    show("q1");
    // Force-disable; Validation v4 will re-enable once 18 unique are selected
    setTimeout(() => { const b = el("toQ2"); if (b) b.disabled = true; }, 0);
  };
  el("toQ1").onclick = _goQ1;

  el("backToInstructions").onclick = () => show("instructions");

  const _goQ2 = () => {
    const l = el("list-q2");
    l.innerHTML = "";
    (S.questions || []).slice(18, 35).forEach((q, i) => l.appendChild(makeQ(q, 19 + i)));
    show("q2");
    // Force-disable; Validation v4 will re-enable once ≥17 unique are selected
    setTimeout(() => { const b = el("submitAll"); if (b) b.disabled = true; }, 0);
  };
  el("toQ2").onclick = _goQ2;

  el("backToQ1").onclick = () => show("q1");

  el("submitAll").onclick = () => {
    const totals = computeTotals();
    el("scorePercent").textContent = "OVERALL SCORE " + totals.pct + "%";
    const gauge = el("gauge");
    gauge.style.setProperty("--marker", totals.pct + "%");
    gauge.style.position = "relative";
    let markerStyle = document.getElementById("markerStyle");
    if (!markerStyle) {
      markerStyle = document.createElement("style");
      markerStyle.id = "markerStyle";
      document.head.appendChild(markerStyle);
    }
    markerStyle.textContent = ".gauge::after{left: calc(var(--marker) - 5px);}";
    let rec = "";
    if (totals.pct < 50) rec = "You are behind and need more support. Please contact your coach and ask your team members for guidance";
    else if (totals.pct < 70) rec = "Focus on developing yourself. Practice makes you better. Ask for honest feedback from your friends so you know what you can do better";
    else if (totals.pct < 85) rec = "Great hospitality! Keep challenging yourself and help others by giving them honest and positive feedback";
    else rec = "Awesome! Your understanding of BED is an inspiration for others. Continue to lead others by example";
    document.getElementById("recText").textContent = rec;
    renderGroupResults();
    show("finish");
  };

  el("backToQ2").onclick = () => show("q2");
  el("nextToPeer").onclick = () => show("congrats");

  el("congratsBack").onclick = () => show("finish");

  // Validation listeners
  ["nick", "email", "hotel", "peerName", "peerEmail", "peerHotel"].forEach((id) => {
    el(id).addEventListener("input", validateWelcome);
    el(id).addEventListener("change", validateWelcome);
  });
  validateWelcome();
         
             // Subheader update
             const subheaderEl = document.querySelector("p.subheader");
             const _oldShow = show;
             show = function (id) {
                 _oldShow(id);
                 if (!subheaderEl) return;
                 if (id === "q1") {
                     subheaderEl.textContent = "STATEMENTS PART ONE";
                 } else if (id === "q2") {
                     subheaderEl.textContent = "STATEMENTS PART TWO";
                 } else if (id === "congrats") {
                     subheaderEl.textContent = "PEER REVIEW FORM";
                 } else {
                     subheaderEl.textContent = "PEER REVIEW FORM";
                 }
             };
         
             function formatDate() {
                 try {
                     const dt = new Date();
                     const day = String(dt.getDate()).padStart(2, "0"); // 01–31
                     const month = String(dt.getMonth() + 1).padStart(2, "0"); // 01–12
                     const year = dt.getFullYear();
                     return `${day}-${month}-${year}`;
                 } catch (_) {
                     return "";
                 }
             }
             function buildPdfReport() {
                 // Date + score box
                 const totals = computeTotals();
                 document.getElementById("pdfDate").textContent = "assessment date " + formatDate();
                 document.getElementById("pdfTotalPct").textContent = (isFinite(totals.pct) ? totals.pct : "—") + "%";
                 document.getElementById("pdfTotalRaw").textContent = (totals.raw || 0) + " of " + ((S.questions || []).length * 5 || 175);
                 // === PDF recommendation band (under the date) ===
                 (function () {
                     const recTarget = document.getElementById("pdfBandText");
                     if (!recTarget) return;
                     let rec = "";
                     if (totals.pct < 50) {
                         rec = "You are behind and need more support. Please contact your coach and ask your team members for guidance";
                     } else if (totals.pct < 70) {
                         rec = "Focus on developing yourself. Practice makes you better. Ask for honest feedback from your friends so you know what you can do better";
                     } else if (totals.pct < 85) {
                         rec = "Great hospitality! Keep challenging yourself and help others by giving them honest and positive feedback";
                     } else {
                         rec = "Awesome! Your understanding of BED is an inspiration for others. Continue to lead others by example";
                     }
         
                     recTarget.innerHTML =
                         "<div style='line-height:1.4; font-size:16px; color:#434343; font-weight:600;'>Your overall score is " +
                         totals.pct +
                         "% based on " +
                         totals.raw +
                         " out of " +
                         ((S.questions || []).length * 5 || 175) +
                         " points. Here's what that means:</div>" +
                         "<div style='font-size:16px; color:#434343; font-weight:600;'>" +
                         rec +
                         "</div>";
         
                     // Info
                     document.getElementById("pdfEmpName").textContent = document.getElementById("nick").value || "";
                     document.getElementById("pdfEmpEmail").textContent = document.getElementById("email").value || "";
                     document.getElementById("pdfEmpHotel").textContent = document.getElementById("hotel").value || "";
                     document.getElementById("pdfPeerName").textContent = document.getElementById("peerName").value || "";
                     document.getElementById("pdfPeerEmail").textContent = document.getElementById("peerEmail").value || "";
                     document.getElementById("pdfPeerHotel").textContent = document.getElementById("peerHotel").value || "";
                 })();
         
                 // Group rows
                 const gp = computeGroupPercents();
                 const descMap = groupDescMap();
                 const order = ["Hospitality Skills", "Hospitality Competencies", "Taking Ownership", "Collaboration"];
                 const body = document.getElementById("pdfGroupRows");
                 body.innerHTML = "";
                 order.forEach((name) => {
                     const tr = document.createElement("tr");
                     const tdName = document.createElement("td");
                     tdName.textContent = "Score " + name;
                     const tdPct = document.createElement("td");
                     tdPct.textContent = (gp[name] != null ? gp[name] : "—") + "%";
                     const tdDesc = document.createElement("td");
                     tdDesc.textContent = descMap[name] || "(add description)";
                     tr.appendChild(tdName);
                     tr.appendChild(tdPct);
                     tr.appendChild(tdDesc);
                     body.appendChild(tr);
                 });
         
                 // Statements table
                 const tb = document.querySelector("#pdfStatements tbody");
                 tb.innerHTML = "";
                 (S.questions || []).forEach((q, i) => {
                     const tr = document.createElement("tr");
                     const tdNo = document.createElement("td");
                     tdNo.textContent = i + 1;
                     tdNo.className = "st-no";
                     const tdSt = document.createElement("td");
                     tdSt.innerHTML = '<div class="st-title">' + stripLeadingNumber(q.statement || "") + "</div>" + (q.subtext ? '<div class="muted">' + q.subtext + "</div>" : "");
                     const tdGp = document.createElement("td");
                     tdGp.textContent = q.group || "";
                     const tdRt = document.createElement("td");
                     tdRt.textContent = S.answers[q.id] != null ? S.answers[q.id] : "";
                     tdRt.className = "st-rating";
                     tr.appendChild(tdNo);
                     tr.appendChild(tdSt);
                     tr.appendChild(tdGp);
                     tr.appendChild(tdRt);
                     tb.appendChild(tr);
                 });
             }
         
             document.getElementById("congratsPdf").onclick = () => {
                 buildPdfReport();
                 window.print();
             };
         
             // Init
             loadQuestions();
         })();
      </script>
      <script>
         // === Validation patch v4: DOM-based completion (resilient) ===
         (function () {
             function uniqueAnsweredCount(containerId) {
                 var box = document.getElementById(containerId);
                 if (!box) return 0;
                 var items = box.querySelectorAll(".q-item");
                 var answered = 0;
                 items.forEach(function (it) {
                     if (it.querySelector(".pill.selected")) answered++;
                 });
                 return answered;
             }
             function q1Done() {
                 return uniqueAnsweredCount("list-q1") >= 18;
             }
             function q2Done() {
                 return uniqueAnsweredCount("list-q2") >= 17;
             }
         
             function sync() {
                 try {
                     var q1Visible = document.getElementById("q1") && document.getElementById("q1").style.display !== "none";
                     var q2Visible = document.getElementById("q2") && document.getElementById("q2").style.display !== "none";
                     var b1 = document.getElementById("toQ2");
                     if (b1 && q1Visible) b1.disabled = !q1Done();
                     var b2 = document.getElementById("submitAll");
                     if (b2 && q2Visible) b2.disabled = !q2Done();
                 } catch (_) {}
             }
         
             // Monitor pill clicks
             document.addEventListener(
                 "click",
                 function (ev) {
                     var t = ev.target;
                     if (t && t.classList && t.classList.contains("pill")) {
                         // Wait a tick for .selected class to update, then sync
                         setTimeout(sync, 0);
                     }
                 },
                 true
             );
         
             // Wrap show() to re-sync after page changes
             if (typeof window.show === "function") {
                 var oldShow = window.show;
                 window.show = function (id) {
                     oldShow(id);
                     setTimeout(sync, 0);
                 };
             }
         
             // Hard guard
             document.addEventListener(
                 "click",
                 function (ev) {
                     var id = ev.target && ev.target.id;
                     if (id === "toQ2" && !q1Done()) {
                         ev.preventDefault();
                         ev.stopPropagation();
                     }
                     if (id === "submitAll" && !q2Done()) {
                         ev.preventDefault();
                         ev.stopPropagation();
                     }
                 },
                 true
             );
         
             // Initial sync
             document.addEventListener("DOMContentLoaded", function () {
                 setTimeout(sync, 0);
             });
             setTimeout(sync, 50);
         })();
         // === End patch v4 ===
      </script>
      <script>
         (function () {
             var bar = document.querySelector("#pdfReport .statements-bar");
             if (!bar) return;
             var labelStmt = bar.querySelector(".lbl-stmt");
             if (labelStmt) {
                 labelStmt.textContent = "STATEMENTS";
             }
             var labelGroup = bar.querySelector(".lbl-group");
             if (labelGroup) {
                 labelGroup.textContent = "GROUP";
             }
             var labelScore = bar.querySelector(".lbl-score");
             if (labelScore) {
                 labelScore.textContent = "SCORE";
             }
         })();
      </script>

        <script>
         (function () {
           // Date format: DDMMMYYYY (e.g., 24Sep2025)
           function formatDateDDMMMYYYY(d = new Date()) {
             const mon = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
             const dd = String(d.getDate()).padStart(2, "0");
             return `${dd}${mon[d.getMonth()]}${d.getFullYear()}`;
           }
         
           // Try multiple sources to get overall % (robust)
           function getOverallPct() {
             try {
               if (typeof window.computeOverallPercent === "function") {
                 const v = window.computeOverallPercent();
                 if (!isNaN(v)) return Math.round(v);
               }
             } catch (e) {}
             try {
               if (window.totals && typeof window.totals.pct === "number") return Math.round(window.totals.pct);
             } catch (e) {}
             const sp = document.getElementById("scorePercent");
             if (sp) {
               const m = sp.textContent.match(/(\d+)\s*%/);
               if (m) return parseInt(m[1], 10);
             }
             return 0;
           }
         })();
      </script>
      <script>
         // === Final hot-fix v3 (must be the last script) ===
         (function () {
             const MAP = {
                 "Hospitality Skills": "Hospitality skills",
                 "Hospitality Competencies": "BED competencies",
                 "Taking Ownership": "Taking ownership",
                 Collaboration: "Collaboration",
             };
             const ORDER = ["Hospitality skills", "BED competencies", "Taking ownership", "Collaboration"];
             const DESC = {
                 "Hospitality skills": "Practical service actions and daily guest care done the BED way.",
                 "BED competencies": "Reading people and situations; proactive judgement; turning intent into consistent action.",
                 "Taking ownership": "Acting independently, fixing problems, and sharing responsibility for outcomes.",
                 Collaboration: "Building trust, communicating clearly, and helping across the BED community.",
             };
             const norm = (n) => MAP[n] || n;
         
             function S() {
                 return window.__S || window.S || {};
             }
         
             function ensureNormalized() {
                 const s = S();
                 if (Array.isArray(s.questions)) s.questions.forEach((q) => (q.group = norm(q.group || "")));
                 if (Array.isArray(s.groups))
                     s.groups.forEach((g) => {
                         g.name = norm(g.name || "");
                         g.description = g.description || DESC[g.name] || "";
                     });
             }
         
             function computeGroupPercents() {
                 ensureNormalized();
                 const s = S(),
                     buckets = {};
                 (s.questions || []).forEach((q) => {
                     const g = norm(q.group || "");
                     if (!g) return;
                     (buckets[g] ||= []).push(parseInt((s.answers || {})[q.id], 10) || 0);
                 });
                 const out = {};
                 Object.keys(buckets).forEach((g) => {
                     const vals = buckets[g].filter((v) => v > 0);
                     out[g] = vals.length ? Math.round(25 + ((vals.reduce((a, b) => a + b, 0) / vals.length - 1) / 4) * 75) : 0;
                 });
                 return out;
             }
         
             function orderedNames() {
                 const names = new Set();
                 (S().questions || []).forEach((q) => {
                     const n = norm(q.group);
                     if (n) names.add(n);
                 });
                 (S().groups || []).forEach((g) => names.add(norm(g.name)));
                 const arr = Array.from(names);
                 return arr.sort((a, b) => (ORDER.indexOf(a) + 1 || 999) - (ORDER.indexOf(b) + 1 || 999));
             }
         
             // --- FORCE our renderers (overwrite anything defined earlier)
             window.renderGroupResults = function () {
                 ensureNormalized();
                 const holder = document.getElementById("groupResults");
                 if (!holder) return;
                 const pct = computeGroupPercents();
                 const desc = {};
                 (S().groups || []).forEach((g) => (desc[g.name] = g.description || DESC[g.name] || ""));
                 holder.innerHTML = "";
                 orderedNames().forEach((name) => {
                     const p = pct[name] ?? 0;
                     const wrap = document.createElement("div");
                     wrap.className = "group-row";
                     wrap.innerHTML = '<div style="font-weight:700">' + name + " " + p + "%</div>" + '<div class="group-desc">' + (desc[name] || "") + "</div>";
                     holder.appendChild(wrap);
                 });
             };
         
             const _build = window.buildPdfReport;
             window.buildPdfReport = function () {
                 ensureNormalized();
                 if (typeof _build === "function") _build();
                 const body = document.getElementById("pdfGroupRows");
                 if (!body) return;
                 body.innerHTML = "";
                 const pct = computeGroupPercents();
                 const desc = {};
                 (S().groups || []).forEach((g) => (desc[g.name] = g.description || DESC[g.name] || ""));
                 orderedNames().forEach((name) => {
                     const tr = document.createElement("tr");
                     const td1 = document.createElement("td");
                     td1.textContent = name;
                     const td2 = document.createElement("td");
                     td2.textContent = (pct[name] ?? 0) + "%";
                     const td3 = document.createElement("td");
                     td3.textContent = desc[name] || "";
                     tr.appendChild(td1);
                     tr.appendChild(td2);
                     tr.appendChild(td3);
                     body.appendChild(tr);
                 });
             };
         
             // Re-normalize and re-render at the exact moments that matter
             window.addEventListener("load", ensureNormalized);
             document.addEventListener(
                 "click",
                 function (ev) {
                     if (ev.target && ev.target.id === "submitAll") {
                         ensureNormalized();
                         setTimeout(window.renderGroupResults, 0);
                     }
                     if (ev.target && ev.target.id === "congratsPdf") {
                         ensureNormalized();
                         setTimeout(window.buildPdfReport, 0);
                     }
                 },
                 true
             );
         })();
      </script>
    
   </body>
</html>
