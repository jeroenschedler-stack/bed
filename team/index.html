<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>BED HOSPITALITY — Self-Assessment</title>

  <!-- Base styles -->
  <style>
    :root{
      --pad:20px; --label-w:96px; --gap:6px;
      --brand-blue:#1E90FF; --blue:#1E90FF;
      --progress-red:#E11D48; --progress-gray:#f3f4f6; --gray-300:#cfd4dc;
      --text:#111; --muted:#555; --line:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui, Arial, sans-serif; background:#F9FAFB; color:var(--text); margin:0}
    .container{width:100%; margin:0; padding:24px var(--pad)}

    .h1, h1 {
      font-size:20pt; margin:0 0 8px 0; line-height:1.2;
      font-weight:900; color:#444;
    }
    .subheader{
      font-size:15pt; font-weight:800; color:#444; margin:0 0 12px 0;
    }
    .section-title{
      font-size:18pt; font-weight:700; color:#444; margin:18px 0 10px 0; line-height:1.25;
    }
    .intro{
      font-size:11pt; font-weight:400; line-height:1.4; color:#444; margin:4px 0 14px 0;
    }

    .progress{display:flex; gap:10px; margin:6px 0 16px 0}
    .dot{ width:14px; height:14px; border-radius:50%; background:var(--progress-gray); border:1px solid #e5e7eb; }
    .dot.active{background:var(--progress-red); border-color:var(--progress-red)}

    .row{display:grid; grid-template-columns:minmax(84px, var(--label-w)) 1fr; column-gap:var(--gap); align-items:center; margin:10px 0}
    .row>label{ font-size:11pt; font-weight:400; color:#444; white-space:normal; word-break:break-word; }
    .row>input, .row>select{ width:100%; padding:10px 12px; font-size:10pt; border:1px solid var(--gray-300); border-radius:10px; background:#fff; transition:box-shadow .15s, border-color .15s}
    .row>input:focus, .row>select:focus{outline:none; border-color:rgba(30,144,255,.8); box-shadow:0 0 0 3px rgba(30,144,255,.18); background:#fff}
    select:invalid{color:#aaa}

    /* Button row (globally right aligned with one blank line above) */
    .actions{padding-left:calc(var(--label-w) + var(--gap)); margin-top:14px; display:flex; gap:10px; justify-content:flex-end}

    /* Base button */
    button { width: 100px; height: 42px; font-size: 12pt; border: none; border-radius: 14px; text-align: center; }
    button:enabled{background:var(--blue); color:#fff; cursor:pointer;}
    button:disabled{background:#ccc; color:#666; cursor:not-allowed;}
    .btn-secondary{width:120px; height:42px; font-size:12pt;}

    /* QUESTIONS */
    .q-item{padding:12px 0;  display:grid; grid-template-columns: 26px 1fr; column-gap:6px; align-items:baseline}
    .q-num{font-size:11pt; font-weight:500; line-height:1.4; color:#444; text-align:right;}
    .q-body{display:block}
    .q-title{display:block; font-size:11pt; font-weight:500; margin:0 0 3px 0; line-height:1.4; color:#444;}
    .q-sub{display:block; font-size:11pt; font-weight:400; margin:0 0 8px 0; line-height:1.4; color:#444;}
    .pill{display:inline-block; width:30px; height:30px; line-height:30px; text-align:center; border:1px solid #cfcfcf; border-radius:50%; margin-right:10px; cursor:pointer; user-select:none; font-size:16px}
    .pill.selected{background:var(--blue); color:#fff}

    /* SCORE */
    .score-kicker{font-size:11pt; font-weight:400; color:#808080; margin:12px 0 8px 0}
    .score-big{font-size:20pt; font-weight:900; color:#444; margin:0 0 24px 0}
    .gauge{position:relative; height:28px; border-radius:8px; background:linear-gradient(90deg,#ef4444 0%, #f59e0b 35%, #fbbf24 50%, #84cc16 70%, #22c55e 100%);}
    .gauge::after{content:""; position:absolute; top:-8px; bottom:-8px; width:10px; border-radius:6px; background:#444}

    /* Congrats */
    .big-check{width:120px; height:120px; border-radius:60px; background:var(--blue); display:flex; align-items:center; justify-content:center; margin:16px auto}
    .big-check:after{content:'✔'; color:#fff; font-weight:800; font-size:54px}
    .center{text-align:center}
    .number-circle {display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:50%; background-color:#1e90ff; color:#fff; font-size:16px; font-weight:bold; margin-right:10px;}
    .step {display:flex; align-items:center; margin:6px 0; font-size:17px; font-weight:600; color:#444;}

    .rec-text{font-size:11pt; font-weight:500; color:#444; margin-top:24px; line-height:1.55;}
    .group-results-header{font-size:18pt; font-weight:800; color:#444; margin-bottom:8px;}
    .rec-kicker{font-size:10pt; font-weight:400; color:#999; margin:12px 0 8px 0}
    .group-desc{line-height:1.35; margin-top:2px; margin-bottom:14px; color:#666; font-size:.95em;}
    .score-section{margin-top:40px;}
    .group-row{padding:2px 0; margin-bottom:0;}

    @media (max-width:340px){ .row{grid-template-columns:1fr; row-gap:6px} .actions{padding-left:0} .q-item{grid-template-columns: 26px 1fr;} }

    /* Hidden headings for a11y */
    .visually-hidden {
      position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;
    }
  </style>

  <!-- Confirmation modal + global button uniformity -->
  <style>
    #confirmModal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    #confirmModal .modal-box{background:#fff;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.25);padding:22px 24px;width:86%;max-width:380px;font-family:system-ui,Arial,sans-serif;text-align:left}
    #confirmModal .title{font-size:17px;font-weight:700;color:#111;margin:0 0 8px}
    #confirmModal .text{font-size:15px;font-weight:400;color:#333;line-height:1.5;margin:0 0 18px}
    #confirmModal .actions{display:flex;justify-content:flex-end;gap:10px}
    #confirmModal button{font-size:15px;font-weight:600;border:none;border-radius:10px;padding:8px 22px;cursor:pointer}
    #confirmModal .btn-cancel{background:#ddd;color:#333}
    #confirmModal .btn-ok{background:#1E90FF;color:#fff}

    /* Global uniform button look (incl. popups) + right-align rows */
    button,
    a.btn,
    input[type="button"],
    input[type="submit"],
    input[type="reset"],
    .popup button, .popup a.btn,
    .modal button, .modal a.btn,
    .confirm button, .confirm a.btn {
      box-sizing:border-box !important; width:100px !important; min-width:100px !important; max-width:100px !important;
      height:42px !important; font-family:system-ui, Arial, sans-serif !important;
      font-size:13pt !important; font-weight:600 !important; text-transform:none !important;
      text-align:center !important; padding:10px 12px !important;
      color:#fff !important; background-color:#1E90FF !important; border:none !important; border-radius:12px !important;
      white-space:nowrap !important; display:inline-block !important; cursor:pointer !important; transition:background .2s ease-in-out;
    }
    button:hover:not(:disabled),
    a.btn:hover:not(:disabled),
    .popup button:hover:not(:disabled),
    .modal button:hover:not(:disabled),
    .confirm button:hover:not(:disabled){
      background-color:#187bcd !important;
    }
    button:disabled,
    .popup button:disabled,
    .modal button:disabled,
    .confirm button:disabled{
      background-color:#ccc !important; color:#666 !important; cursor:not-allowed !important;
    }
    .actions, .popup .actions, .modal .actions, .confirm .actions, .row-btns{
      display:flex !important; justify-content:flex-end !important; align-items:center !important; gap:12px !important; margin-top:20px !important;
    }
  </style>

  <!-- PRINT styles (PDF layout) -->
  <style>
    #pdfReport{display:none}
    @media print{
      body{background:#fff; color:#000}
      main, .modal-backdrop{display:none !important}
      #pdfReport{display:block; font-family:Arial, Helvetica, sans-serif; padding:18px 24px}
      :root{ --blue:#1E90FF; }

      .pdf-top{display:grid; grid-template-columns: 1fr 220px; gap:16px; align-items:start; margin-bottom:10px}
      .pdf-title{font-size:45px; font-weight:1000; color:var(--blue); margin:0}
      .pdf-sub { font-size:30px; font-weight:600; color:var(--blue); margin:2px 0; line-height:1.2; text-align:left; }
      .pdf-date { font-size:18px; font-weight:500; color:var(--blue); margin:2px 0; line-height:1.2; text-align:left; }
      .pdf-divider{height:1px; background:#cfd4dc; margin:8px 0 14px 0}

      .score-box{background:var(--blue) !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; color:#fff !important; border-radius:6px; padding:12px 14px; text-align:center;}
      .score-box .pct{font-size:40px; font-weight:900; margin:4px 0 2px 0}
      .score-box .raw{font-size:20px; font-weight:800; color:#fff !important; margin-bottom:6px;}

      .sec-h { background:var(--blue) !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; color:#fff !important; font-weight:800; text-transform:uppercase; padding:6px 10px; border-radius:4px; margin:16px 0 8px 0; }

      table{width:100%; border-collapse:collapse}
      th{ background:var(--blue) !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; color:#fff !important; font-weight:800; text-transform:uppercase; font-size:12px; padding:8px }
      td{ font-size:12px; padding:8px; vertical-align:top }

      /* Only horizontal light-blue lines */
      #pdfReport table, #pdfReport th, #pdfReport td { border: none !important; }
      #pdfReport td { border-bottom: 0.5px solid #87CEFA !important; }
      #pdfReport tr:last-child td { border-bottom: none !important; }

      /* Info table */
      #pdfReport #pdfInfoTable { table-layout:fixed; width:100%; }
      #pdfReport #pdfInfoTable td {
        padding:8px 1px !important; font-size:12px !important; vertical-align:middle !important; text-align:left !important;
        border-bottom:0.5px solid #87CEFA !important; overflow-wrap:anywhere; word-break:break-word;
      }
      #pdfReport #pdfInfoTable tr:last-child td { border-bottom:none !important; }
      #pdfReport #pdfInfoTable td:nth-child(odd){ font-weight:600; }

      /* Statements header alignment + widths */
      #pdfReport .statements-bar {
        display:grid !important; grid-template-columns: 10% 55% 20% 15% !important; align-items:center !important; padding:6px 10px !important; margin:16px 0 8px 0 !important;
      }
      #pdfReport .statements-table { table-layout:fixed; width:100%; }
      #pdfReport #pdfStatements thead { display:none !important; } /* hide duplicate header */

      /* Page size */
      @page { size:A4; margin:15mm; }
    }
  </style>
</head>

<body>
  <main class="container">
    <h1>BED HOSPITALITY 2.0</h1>
    <p class="subheader">TEAM MEMBER FORM</p>
    <div class="progress" id="progressHeader">
      <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      <span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </div>

    <!-- PAGE 1 -->
    <section id="welcome">
      <h2 class="section-title">team member information</h2>
      <div class="row"><label for="nick">name</label><input id="nick" placeholder="your name"></div>
      <div class="row">
        <label for="email">email</label>
        <input id="email" name="email" type="email" required autocomplete="email" placeholder="your email address">
      </div>
      <div class="row">
        <label for="hotel">location</label>
        <select id="hotel" required>
          <option disabled selected value="">select your location</option>
          <option>BED Changkian</option>
          <option>BED Phrasingh</option>
          <option>BED Nimman</option>
          <option>BED Chiangmai Gate</option>
          <option>BED Flying</option>
          <option>BED Support</option>
        </select>
      </div>

      <h2 class="section-title">peer reviewer information</h2>
      <p class="intro">After you assess yourself a friend will review you. You can ask anyone in your team who knows you well and worked in BED for at least 12 months</p>
      <div class="row"><label for="peerName">name</label><input id="peerName" placeholder="peer reviewer name"></div>
      <div class="row"><label for="peerEmail">email</label><input id="peerEmail" type="email" placeholder="peer reviewer email"></div>
      <div class="row">
        <label for="peerHotel">location</label>
        <select id="peerHotel" required>
          <option disabled selected value="">select peer location</option>
          <option>BED Changkian</option>
          <option>BED Phrasingh</option>
          <option>BED Nimman</option>
          <option>BED Chiangmai Gate</option>
          <option>BED Flying</option>
          <option>BED Support</option>
        </select>
      </div>
      <div class="actions">
        <button id="toInstructions" disabled>Start</button>
      </div>
    </section>

    <!-- Instructions -->
    <section id="instructions" style="display:none;">
      <h2 class="section-title">INSTRUCTIONS</h2>
      <p class="intro">
        Read each statement and think how you act in these situations. Then rating yourself from 1-5. Be honest with yourself. Looking in the mirror help you to understand what you're good at and what you can do better
      </p>

      <h2 class="section-title">RATING</h2>
      <ul class="scale-list" style="list-style:none; padding:0; margin:10px 0;">
        <li class="scale-item" style="display:flex; align-items:center; gap:10px; margin:8px 0; font-size:12pt;">
          <span class="badge" style="width:28px; height:28px; border-radius:50%; background:var(--blue); color:#fff; display:inline-flex; align-items:center; justify-content:center; font-weight:700;">1</span>
          <span>I am not good at this</span>
        </li>
        <li class="scale-item" style="display:flex; align-items:center; gap:10px; margin:8px 0; font-size:12pt;">
          <span class="badge" style="width:28px; height:28px; border-radius:50%; background:var(--blue); color:#fff; display:inline-flex; align-items:center; justify-content:center; font-weight:700;">2</span>
          <span>I can be better at this</span>
        </li>
        <li class="scale-item" style="display:flex; align-items:center; gap:10px; margin:8px 0; font-size:12pt;">
          <span class="badge" style="width:28px; height:28px; border-radius:50%; background:var(--blue); color:#fff; display:inline-flex; align-items:center; justify-content:center; font-weight:700;">3</span>
          <span>I am average at this</span>
        </li>
        <li class="scale-item" style="display:flex; align-items:center; gap:10px; margin:8px 0; font-size:12pt;">
          <span class="badge" style="width:28px; height:28px; border-radius:50%; background:var(--blue); color:#fff; display:inline-flex; align-items:center; justify-content:center; font-weight:700;">4</span>
          <span>I am good at this</span>
        </li>
        <li class="scale-item" style="display:flex; align-items:center; gap:10px; margin:8px 0; font-size:12pt;">
          <span class="badge" style="width:28px; height:28px; border-radius:50%; background:var(--blue); color:#fff; display:inline-flex; align-items:center; justify-content:center; font-weight:700;">5</span>
          <span>I am very good at this</span>
        </li>
      </ul>

      <div class="actions">
        <button class="btn-secondary" id="backToWelcome">Back</button>
        <button id="toQ1">Start</button>
      </div>
    </section>

    <!-- Q1 -->
    <section id="q1" style="display:none;">
      <h2 class="visually-hidden">Question 1</h2>
      <div id="list-q1"></div>
      <div class="actions">
        <button class="btn-secondary" id="backToInstructions">Back</button>
        <button id="toQ2" disabled>Next</button>
      </div>
    </section>

    <!-- Q2 -->
    <section id="q2" style="display:none;">
      <h2 class="visually-hidden">Question 2</h2>
      <div id="list-q2"></div>
      <div class="actions">
        <button class="btn-secondary" id="backToQ1">Back</button>
        <button id="submitAll" disabled>Submit</button>
      </div>
    </section>

    <!-- Score -->
    <section id="finish" style="display:none;">
      <h2 class="visually-hidden">Overall Score</h2>
      <div class="score-section">
        <div class="score-kicker">self-assessment score</div>
        <div class="score-big" id="scorePercent">OVERALL SCORE —%</div>
        <div class="gauge" id="gauge"></div>
        <div class="rec-kicker"></div>
        <div class="rec-text" id="recText">—</div>
      </div>

      <div id="groupResultsContainer" style="margin-top:18px;">
        <div class="group-summary">
          <div class="group-results-header group-title" style="font-weight:900; margin-bottom:8px;">SCORE BY GROUP</div>
          <div id="groupResults"></div>
        </div>
      </div>

      <div class="actions">
        <button class="btn-secondary" id="backToQ2">Back</button>
        <button id="nextToPeer">Next</button>
      </div>
    </section>

    <!-- Congrats -->
    <section id="congrats" style="display:none;">
      <div class="big-check"></div>
      <div class="center">
        <h3 style="font-size:32px; margin:8px 0 6px 0; color:#444;">self-assessment<br/>completed</h3>
        <div style="margin-top:10px;">
          <div class="step"><span class="number-circle">1</span><span>Your scores are recorded</span></div>
          <div class="step"><span class="number-circle">2</span><span>Click PDF to download the report</span></div>
          <div class="step"><span class="number-circle">3</span><span>Ask your peer to review you</span></div>
        </div>
      </div>
      <div class="page-actions" style="display:flex; gap:14px; justify-content:flex-end; margin-top:10px;">
        <button class="btn-secondary btn-wide" id="congratsBack">Back</button>
        <button class="btn-wide" id="congratsPdf">PDF</button>
      </div>
    </section>
  </main>

  <!-- Eligibility modal (welcome -> instructions) -->
  <div class="modal-backdrop" id="eligBackdrop" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50;">
    <div class="modal" style="width:min(92vw, 520px); background:#fff; border-radius:18px; padding:20px; box-shadow:0 20px 60px rgba(0,0,0,.25);">
      <h3 style="margin:0 0 10px 0; font-size:18px;">please confirm V2</h3>
      <p style="margin:0 0 18px 0; font-size:16px; line-height:1.5; color:#222;">my peer knows me well and has worked in BED for at least 12 months</p>
      <div class="row-btns" style="display:flex; justify-content:flex-end; gap:10px;">
        <button class="btn-secondary" id="eligCancel">Cancel</button>
        <button id="eligOk">OK</button>
      </div>
    </div>
  </div>

  <!-- PRINT REPORT (Blue-branded) -->
  <section aria-hidden="true" id="pdfReport">
    <h2 class="visually-hidden">PDF Report</h2>
    <div class="pdf-top">
      <div>
        <div class="pdf-title">BED HOSPITALITY 2.0</div>
        <div class="pdf-sub">team member report</div>
        <div class="pdf-date" id="pdfDate">assessment date —</div>
      </div>
      <div class="score-box">
        <div class="pct" id="pdfTotalPct">—%</div>
        <div class="raw" id="pdfTotalRaw">— OUT OF 175 POINTS</div>
      </div>
    </div>

    <div class="pdf-divider"></div>

    <!-- Information section -->
    <div class="sec-h assess-bar"><span class="lbl-group">INFORMATION</span></div>
    <div class="card" style="padding:0;">
      <table id="pdfInfoTable">
        <colgroup>
          <col style="width:20%;"/><col style="width:30%;"/><col style="width:20%;"/><col style="width:30%;"/>
        </colgroup>
        <tbody>
          <tr><td>team member</td><td id="pdfEmpName"></td><td>peer reviewer</td><td id="pdfPeerName"></td></tr>
          <tr><td>email address</td><td id="pdfEmpEmail"></td><td>email address</td><td id="pdfPeerEmail"></td></tr>
          <tr><td>BED location</td><td id="pdfEmpHotel"></td><td>BED location</td><td id="pdfPeerHotel"></td></tr>
        </tbody>
      </table>
    </div>

    <!-- Score band summary -->
    <div class="sec-h assess-bar"><span class="lbl-group">SCORE SUMMARY</span></div>
    <div id="pdfBandText" style="margin-top:10px; font-size:16px; font-weight:600; color:#434343; width:100%; display:block; text-align:left; line-height:1.5;"></div>

    <!-- Group scores -->
    <div class="sec-h assess-bar"><span class="lbl-group">SCORE BY GROUP</span></div>
    <div class="card" style="padding:0;">
      <table><tbody id="pdfGroupRows"></tbody></table>
    </div>

    <!-- Statements -->
    <div class="sec-h statements-bar">
      <span class="lbl-stmt" style="display:block;">STATEMENTS</span>
      <span class="lbl-group" style="display:block;">GROUP</span>
      <span class="lbl-score" style="display:block;">SCORE</span>
    </div>
    <div class="card" style="padding:0;">
      <table id="pdfStatements" class="statements-table">
        <colgroup><col/><col/><col/><col/></colgroup>
        <thead>
          <tr><th>NO</th><th>STATEMENT</th><th>GROUP</th><th>SCORE</th></tr>
        </thead>
        <tbody id="pdfStatementRows"></tbody>
      </table>
    </div>
  </section>

  <!-- Confirm dialog shown on Q2 submit -->
  <div id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle" aria-describedby="confirmText">
    <div class="modal-box">
      <div id="confirmTitle" class="title">Are you sure?</div>
      <div id="confirmText" class="text">Your assessment scores will be automatically saved.</div>
      <div class="actions">
        <button id="cancelConfirm" class="btn-cancel" type="button">No</button>
        <button id="okConfirm" class="btn-ok" type="button">Yes</button>
      </div>
    </div>
  </div>

  <!-- App logic -->
  <script id="embeddedQuestions" type="application/json">[]</script>
  <script>
    (function () {
      const S = { answers: {}, questions: [], groups: [] };
      window.__S = S;
      const el = (id) => document.getElementById(id);
      const sections = ["welcome", "instructions", "q1", "q2", "finish", "congrats"];

      function show(id) {
        sections.forEach((s) => (document.getElementById(s).style.display = s === id ? "block" : "none"));
        let n = 1;
        if (id === "instructions") n = 2;
        else if (id === "q1") n = 3;
        else if (id === "q2") n = 4;
        else if (id === "finish") n = 5;
        else if (id === "congrats") n = 6;
        setProgress(n);
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
      function setProgress(n) {
        const dots = document.querySelectorAll("#progressHeader .dot");
        dots.forEach((d, i) => d.classList.toggle("active", i < n));
      }
      setProgress(1);

      function stripLeadingNumber(t){ return String(t||"").replace(/^\s*\d+\.\s*/, ""); }

      function makeQ(q, ord) {
        const wrap = document.createElement("div");
        wrap.className = "q-item"; wrap.dataset.qid = q.id;
        const num = document.createElement("div"); num.className = "q-num"; num.textContent = ord + ".";
        const body = document.createElement("div"); body.className = "q-body";
        const title = document.createElement("span"); title.className = "q-title"; title.textContent = stripLeadingNumber(q.statement || "");
        body.appendChild(title);
        if (q.subtext) { const sub = document.createElement("span"); sub.className = "q-sub"; sub.textContent = q.subtext; body.appendChild(sub); }
        for (let v = 1; v <= 5; v++) {
          const p = document.createElement("span"); p.className = "pill"; p.textContent = v; p.dataset.val = v;
          p.onclick = () => { S.answers[q.id] = v; wrap.querySelectorAll(".pill").forEach((x) => x.classList.toggle("selected", x === p)); };
          body.appendChild(p);
        }
        wrap.appendChild(num); wrap.appendChild(body);
        return wrap;
      }

      async function loadQuestions() {
        try {
          const res = await fetch("questions.json?v=" + Date.now(), { cache: "no-store" });
          if (!res.ok) throw new Error("fetch failed");
          const data = await res.json();
          S.questions = data.questions || [];
          S.groups = data.groups || [];
        } catch (e) {
          S.questions = [];
          S.groups = [
            { name: "Hospitality skills", description: "Standard skills for daily tasks and guest services" },
            { name: "BED competencies", description: "Advanced abilities to read people and situations" },
            { name: "Taking ownership", description: "Acting independently and sharing responsibility" },
            { name: "Collaboration", description: "Building trust and helping others across BED" },
          ];
        }
      }

      function validateWelcome() {
        const allFilled = ["nick", "email", "hotel", "peerName", "peerEmail", "peerHotel"].every((id) => el(id).value && el(id).value.trim() !== "");
        el("toInstructions").disabled = !allFilled;
      }

      function computeTotals() {
        const ids = (S.questions || []).map((q) => q.id);
        const answered = ids.filter((id) => S.answers[id] != null);
        const raw = answered.reduce((sum, id) => sum + (Number(S.answers[id] || 0) || 0), 0);
        const max = (S.questions || []).length * 5;
        const avg = answered.length ? raw / answered.length : 0;
        const pct = answered.length ? Math.round(25 + ((avg - 1) / 4) * 75) : 25;
        return { raw, max, pct };
      }

      function computeGroupPercents() {
        const byGroup = {};
        (S.groups || []).forEach((g) => (byGroup[g.name] = []));
        (S.questions || []).forEach((q) => {
          const g = q.group;
          const v = parseInt(S.answers[q.id], 10);
          if (g && !isNaN(v) && v > 0) (byGroup[g] ||= []).push(v);
        });
        const res = {};
        Object.keys(byGroup).forEach((g) => {
          const vals = byGroup[g];
          if (!vals.length) { res[g] = 0; return; }
          const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
          res[g] = Math.round(25 + ((avg - 1) / 4) * 75);
        });
        return res;
      }

      function groupDescMap() {
        const m = {};
        (S.groups || []).forEach((g) => (m[g.name] = g.description || ""));
        return m;
      }

      function renderGroupResults() {
        const holder = document.getElementById("groupResults");
        if (!holder) return;
        const gp = computeGroupPercents();
        const desc = groupDescMap();
        const order = ["Hospitality skills", "BED competencies", "Taking ownership", "Collaboration"];
        holder.innerHTML = "";
        order.forEach((name) => {
          const p = gp[name] ?? 0;
          const block = document.createElement("div");
          block.className = "group-row";
          block.innerHTML = `<div style="font-weight:700">${name} ${p}%</div><div class="group-desc">${desc[name] || ""}</div>`;
          holder.appendChild(block);
        });
      }

      function formatDate() {
        try {
          const dt = new Date();
          const day = String(dt.getDate()).padStart(2, "0");
          const month = String(dt.getMonth() + 1).padStart(2, "0");
          const year = dt.getFullYear();
          return `${day}-${month}-${year}`;
        } catch (_) { return ""; }
      }

      // Build the entire PDF DOM (date, totals, band text, info, groups, statements)
      function buildPdfReport() {
        const totals = computeTotals();
        // Top box
        el("pdfDate").textContent = "assessment date " + formatDate();
        el("pdfTotalPct").textContent = (isFinite(totals.pct) ? totals.pct : "—") + "%";
        el("pdfTotalRaw").textContent = (totals.raw || 0) + " of " + ((S.questions || []).length * 5 || 175);

        // Band text (same recommendations as on screen)
        const recTarget = document.getElementById("pdfBandText");
        if (recTarget) {
          let rec = "";
          if (totals.pct < 50) rec = `Your score suggests limited understanding of BED. It is your responsibility to change that. 
            You need passion and common sense to become a full member of the team.<br><br>
            Focus on self-development and that starts with awareness. Observe others but don’t copy and find your own identity. 
            Set a goal per week and ask the team to evaluate your progress. Practice makes people better. Ask your coach for guidance.`;
          else if (totals.pct < 70) rec = `Your score means that you know hospitality but take it too easy. 
            This shows a lack of focus and understanding that BED plays in the Champions League of hospitality.<br><br>
            Be more proactive and focus on providing the very best service. Push yourself to act like an equal and responsible member of the team. 
            Ask your teammates for advice and then ask yourself. Did I do things different today?`;
          else if (totals.pct < 90) rec = `Your score shows that you really understand hospitality and use the core values of BED in daily work. 
            This means you are ready to grow into the next level.<br><br>
            Think about your personal growth. Use your time in BED to learn new things about people, leadership and management. 
            Without challenge work can become routine. Think about new ideas for BED 2.0 and help your team members with positive feedback.`;
          else rec = `Your score suggests that you truly understand BED. You care for people and take ownership of the hotels. 
            Continue to inspire your team and lead them by example.<br><br>
            Drive shared leadership and help develop hotels and people. Use your strengths to grow within the organization and 
            take a more active role in shaping BED 2.0. You are ready for the next step.`;

          recTarget.innerHTML =
            `<div style="line-height:1.6; font-size:16px; color:#434343; font-weight:600;">
               Your overall score is ${totals.pct}% based on ${totals.raw} out of ${((S.questions || []).length * 5 || 175)} points. Here's what that means:
             </div>
             <div style="font-size:16px; color:#434343; font-weight:500; line-height:1.6; margin-top:10px;">${rec}</div>`;
        }

        // Information (from inputs at time of build)
        el("pdfEmpName").textContent  = el("nick").value || "";
        el("pdfEmpEmail").textContent = el("email").value || "";
        el("pdfEmpHotel").textContent = el("hotel").value || "";
        el("pdfPeerName").textContent = el("peerName").value || "";
        el("pdfPeerEmail").textContent= el("peerEmail").value || "";
        el("pdfPeerHotel").textContent= el("peerHotel").value || "";

        // Group rows
        const gp = computeGroupPercents();
        const descMap = groupDescMap();
        const order = ["Hospitality skills", "BED competencies", "Taking ownership", "Collaboration"];
        const body = document.getElementById("pdfGroupRows");
        if (body) {
          body.innerHTML = "";
          order.forEach((name) => {
            const tr = document.createElement("tr");
            const tdName = document.createElement("td"); tdName.textContent = name;
            const tdPct  = document.createElement("td"); tdPct.textContent  = (gp[name] != null ? gp[name] : "—") + "%";
            const tdDesc = document.createElement("td"); tdDesc.textContent = descMap[name] || "(add description)";
            tr.appendChild(tdName); tr.appendChild(tdPct); tr.appendChild(tdDesc);
            body.appendChild(tr);
          });
        }

        // Statement rows
        const tb = document.getElementById("pdfStatementRows");
        if (tb) {
          tb.innerHTML = "";
          (S.questions || []).forEach((q, i) => {
            const tr = document.createElement("tr");
            const tdNo = document.createElement("td"); tdNo.textContent = i + 1; tdNo.className = "st-no";
            const tdSt = document.createElement("td");
            tdSt.innerHTML = `<div class="st-title">${stripLeadingNumber(q.statement || "")}</div>${ q.subtext ? `<div class="muted">${q.subtext}</div>` : "" }`;
            const tdGp = document.createElement("td"); tdGp.textContent = q.group || "";
            const tdRt = document.createElement("td"); tdRt.textContent = S.answers[q.id] != null ? S.answers[q.id] : ""; tdRt.className = "st-rating";
            tr.appendChild(tdNo); tr.appendChild(tdSt); tr.appendChild(tdGp); tr.appendChild(tdRt);
            tb.appendChild(tr);
          });
        }
      }

      // Page flow
      function openElig(){ document.getElementById("eligBackdrop").style.display = "flex"; }
      function closeElig(){ document.getElementById("eligBackdrop").style.display = "none"; }
      const _eligOkBtn = document.getElementById("eligOk");
      const _eligCancelBtn = document.getElementById("eligCancel");

      el("toInstructions").onclick = () => {
        openElig();
        const oldOk = _eligOkBtn.onclick, oldCancel = _eligCancelBtn.onclick;
        _eligOkBtn.onclick = () => { closeElig(); show("instructions"); _eligOkBtn.onclick = oldOk; _eligCancelBtn.onclick = oldCancel; };
        _eligCancelBtn.onclick = () => { closeElig(); _eligOkBtn.onclick = oldOk; _eligCancelBtn.onclick = oldCancel; };
      };
      el("backToWelcome").onclick = () => show("welcome");
      el("toQ1").onclick = () => {
        const l = el("list-q1"); l.innerHTML = "";
        (S.questions || []).slice(0, 18).forEach((q, i) => l.appendChild(makeQ(q, i + 1)));
        show("q1");
      };
      el("backToInstructions").onclick = () => show("instructions");
      el("toQ2").onclick = () => {
        const l = el("list-q2"); l.innerHTML = "";
        (S.questions || []).slice(18, 35).forEach((q, i) => l.appendChild(makeQ(q, 19 + i)));
        show("q2");
      };
      el("backToQ1").onclick = () => show("q1");

      // Intercept Submit on Q2 to show confirm (Yes -> proceed to scoring)
      (function () {
        const modal  = document.getElementById("confirmModal");
        const cancel = document.getElementById("cancelConfirm");
        const ok     = document.getElementById("okConfirm");
        const submit = document.getElementById("submitAll");
        if (!modal || !submit || !cancel || !ok) return;

        const originalSubmit = submit.onclick; // original flow
        let allowPass = false;

        function intercept(e){
          if (allowPass) return;
          e.preventDefault();
          e.stopImmediatePropagation();
          modal.style.display = "flex";
          setTimeout(() => cancel.focus(), 60);
        }
        submit.addEventListener("click", intercept, { capture:true });

        cancel.addEventListener("click", () => { modal.style.display = "none"; });

        ok.addEventListener("click", () => {
          modal.style.display = "none";
          allowPass = true;
          try { typeof originalSubmit === "function" ? originalSubmit() : submit.click(); }
          finally { allowPass = false; }
        });
      })();

      // Submit flow -> scoring page + recommendations + pdf build + sync
      el("submitAll").onclick = () => {
        const totals = computeTotals();
        el("scorePercent").textContent = "OVERALL SCORE " + totals.pct + "%";

        const gauge = el("gauge");
        gauge.style.setProperty("--marker", totals.pct + "%");
        gauge.style.position = "relative";
        let markerStyle = document.getElementById("markerStyle");
        if (!markerStyle) { markerStyle = document.createElement("style"); markerStyle.id = "markerStyle"; document.head.appendChild(markerStyle); }
        markerStyle.textContent = ".gauge::after{left: calc(var(--marker) - 5px);}";

        // Recommendation (screen)
        let rec = "";
        if (totals.pct < 50) rec = `Your score suggests limited understanding of BED. It is your responsibility to change that. 
          You need passion and common sense to become a full member of the team.<br><br>
          Focus on self-development and that starts with awareness. Observe others but don’t copy and find your own identity. 
          Set a goal per week and ask the team to evaluate your progress. Practice makes people better. Ask your coach for guidance.`;
        else if (totals.pct < 70) rec = `Your score means that you know hospitality but take it too easy. 
          This shows a lack of focus and understanding that BED plays in the Champions League of hospitality.<br><br>
          Be more proactive and focus on providing the very best service. Push yourself to act like an equal and responsible member of the team. 
          Ask your teammates for advice and then ask yourself. Did I do things different today?`;
        else if (totals.pct < 90) rec = `Your score shows that you really understand hospitality and use the core values of BED in daily work. 
          This means you are ready to grow into the next level.<br><br>
          Think about your personal growth. Use your time in BED to learn new things about people, leadership and management. 
          Without challenge work can become routine. Think about new ideas for BED 2.0 and help your team members with positive feedback.`;
        else rec = `Your score suggests that you truly understand BED. You care for people and take ownership of the hotels. 
          Continue to inspire your team and lead them by example.<br><br>
          Drive shared leadership and help develop hotels and people. Use your strengths to grow within the organization and 
          take a more active role in shaping BED 2.0. You are ready for the next step.`;
        el("recText").innerHTML = rec;

        renderGroupResults();
        buildPdfReport();                                   // build PDF DOM now
        document.dispatchEvent(new Event('bed:pdf-ready')); // signal: PDF is ready for export
        show("finish");

        // Optional Google Sheet sync
        if (typeof window.syncToSheet === 'function') {
          setTimeout(() => { window.syncToSheet(); }, 500);
        }
      };

      el("backToQ2").onclick = () => show("q2");
      el("nextToPeer").onclick = () => show("congrats");
      el("congratsBack").onclick = () => show("finish");
      el("congratsPdf").onclick = () => { buildPdfReport(); window.print(); };

      // Validation: enable Next/Submit only when answered (DOM-based, resilient)
      (function () {
        function answeredCount(containerId) {
          const box = document.getElementById(containerId); if (!box) return 0;
          return [...box.querySelectorAll(".q-item")].filter(it => it.querySelector(".pill.selected")).length;
        }
        function q1Done(){ return answeredCount("list-q1") >= 18; }
        function q2Done(){ return answeredCount("list-q2") >= 17; }
        function sync(){
          const q1Visible = document.getElementById("q1").style.display !== "none";
          const q2Visible = document.getElementById("q2").style.display !== "none";
          const b1 = document.getElementById("toQ2"); if (b1 && q1Visible) b1.disabled = !q1Done();
          const b2 = document.getElementById("submitAll"); if (b2 && q2Visible) b2.disabled = !q2Done();
        }
        document.addEventListener("click", (ev) => {
          const t = ev.target;
          if (t && t.classList && t.classList.contains("pill")) setTimeout(sync, 0);
          if (ev.target && ev.target.id === "toQ2" && !q1Done()) { ev.preventDefault(); ev.stopPropagation(); }
          if (ev.target && ev.target.id === "submitAll" && !q2Done()) { ev.preventDefault(); ev.stopPropagation(); }
        }, true);
        // Wrap show() to re-sync after page changes
        const oldShow = show;
        show = function(id){ oldShow(id); setTimeout(sync, 0); };

        // Initial
        document.addEventListener("DOMContentLoaded", () => setTimeout(sync, 0));
      })();

      // Subheader label changes by page
      (function(){
        const subheaderEl = document.querySelector("p.subheader");
        const _oldShow = show;
        show = function (id) {
          _oldShow(id);
          if (!subheaderEl) return;
          if (id === "q1") subheaderEl.textContent = "STATEMENTS PART ONE";
          else if (id === "q2") subheaderEl.textContent = "STATEMENTS PART TWO";
          else subheaderEl.textContent = "TEAM MEMBER FORM";
        };
      })();

      // Email helper message (peer email)
      document.addEventListener('DOMContentLoaded', () => {
        const pe = document.getElementById('peerEmail');
        if (!pe) return;
        pe.type = 'email'; pe.required = true; pe.autocomplete = 'email'; pe.setAttribute('inputmode','email');
        const msg = document.createElement('small'); msg.id = 'emailMsg'; msg.style.display = 'block'; msg.style.marginTop = '4px'; pe.after(msg);
        const showMsg = () => { msg.textContent = pe.checkValidity() ? '' : 'Please enter a valid email address'; };
        pe.addEventListener('input', showMsg); pe.addEventListener('blur', showMsg);
      });

      // Init
      ["nick", "email", "hotel", "peerName", "peerEmail", "peerHotel"].forEach((id) => {
        el(id).addEventListener("input", validateWelcome);
        el(id).addEventListener("change", validateWelcome);
      });
      validateWelcome();
      loadQuestions();
    })();
  </script>

  <!-- Inject “Your assessment is recorded.” on finish/congrats for clarity -->
  <script>
    document.addEventListener("bed:pdf-ready", () => {
      const finish = document.getElementById("finish");
      if (!finish) return;
      if (!finish.querySelector("#recordMsg")) {
        const p = document.createElement("p");
        p.id = "recordMsg";
        p.textContent = "Your assessment is recorded.";
        p.style.marginTop = "12px"; p.style.fontSize = "16px"; p.style.color = "#434343"; p.style.textAlign = "left";
        const pdfHint = Array.from(finish.querySelectorAll("p, div")).find(el => el.textContent && el.textContent.includes("Click PDF"));
        pdfHint ? pdfHint.parentNode.insertBefore(p, pdfHint) : finish.appendChild(p);
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      const targetNode = document.getElementById("congrats");
      if (!targetNode) return;
      const observer = new MutationObserver(() => {
        const pdfText = targetNode.querySelector("p");
        if (pdfText && pdfText.textContent.toLowerCase().includes("click pdf")) {
          if (!document.getElementById("recordedMsg")) {
            const msg = document.createElement("p");
            msg.id = "recordedMsg";
            msg.textContent = "Your assessment is recorded.";
            msg.style.fontSize = "16px"; msg.style.color = "#434343"; msg.style.marginBottom = "4px";
            pdfText.parentNode.insertBefore(msg, pdfText);
          }
        }
      });
      observer.observe(targetNode, { childList: true, subtree: true });
    });
  </script>

  <!-- Optional Google Sheets sync loader -->
  <script src="../gsync.js?v=21"></script>
</body>
</html>
